<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>学生成绩管理</title>
    <style>
        body{margin: 10px;}
        .demo-carousel{height: 200px; line-height: 200px; text-align: center;}
    </style>
    <link rel="stylesheet" href="/layui/lib/layui/css/layui.css" media="all">
    <script src="/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script src="/layui/lib/layui/layui.all.js"></script>


</head>
<body>
<blockquote class="layui-elem-quote">学生成绩管理:学生成绩录入，可选择显示列，导出、打印学生成绩信息
    <span class="layui-badge layui-bg-blue" style="font-size: large">批量上传学生成绩，请按指定格式填写Excel></span>
</blockquote>

<div class="demoTable">
    <form class="layui-form"  action="">
        考试日期：
        <div class="layui-inline"> <!-- 注意：这一层元素并不是必须的 -->
            <div class="layui-input-inline">
                <select name="testTime"  lay-filter="selectTestTime" id="selectTestTime"></select>
            </div>
        </div>
    </form>

</div>
<table class="layui-hide" id="test" lay-filter="test"></table>
<div id="add-main" style="display: none;">
    <form class="layui-form" id="add-form"  action="">
        <div class="layui-form-item center" >
            <div class="layui-input-block">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">考试日期</label>
                <div class="layui-input-inline">
                    <input type="text" name="testTime" placeholder="考试日期"  class="layui-input" id="testTime">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">学生</label>
                <div class="layui-input-inline">
                    <select name="studentNum" id="studentNum" lay-verify="required" lay-search="">
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">语文</label>
                <div class="layui-input-inline">
                    <input type="text" name="yuwen" required autocomplete="off" placeholder="语文" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">数学</label>
                <div class="layui-input-inline">
                    <input type="text" name="shuxue" required  placeholder="数学" lay-verify="scoreNum"  autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">英语</label>
                <div class="layui-input-inline">
                    <input type="tel" name="yingyu" required  autocomplete="off" placeholder="英语" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">物理</label>
                <div class="layui-input-inline">
                    <input type="text" name="wuli" required autocomplete="off" placeholder="物理" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">化学</label>
                <div class="layui-input-inline">
                    <input type="text" name="huaxue" required  placeholder="化学" lay-verify="scoreNum"  autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">生物</label>
                <div class="layui-input-inline">
                    <input type="tel" name="shengwu" required  autocomplete="off" placeholder="生物" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary" id="addReset">重置</button>
            </div>
        </div>
    </form>
</div>
<div id="add-modofy" style="display: none;">
    <form class="layui-form" id="modify_form"  action="">
        <div class="layui-form-item center" >
            <div class="layui-input-block">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">考试日期</label>
                <div class="layui-input-inline">
                    <input type="text" name="testTime" placeholder="考试日期" disabled class="layui-input" id="mtestTime">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">学生</label>
                <div class="layui-input-inline">
                    <input name="studentNum" id="mstudentNum" disabled lay-verify="required" class="layui-input" >
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">语文</label>
                <div class="layui-input-inline">
                    <input type="text" name="yuwen" id="myuwen" required autocomplete="off" placeholder="语文" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">数学</label>
                <div class="layui-input-inline">
                    <input type="text" name="shuxue" id="mshuxue" required  placeholder="数学" lay-verify="scoreNum"  autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">英语</label>
                <div class="layui-input-inline">
                    <input type="tel" name="yingyu" id="myingyu" required  autocomplete="off" placeholder="英语" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">物理</label>
                <div class="layui-input-inline">
                    <input type="text" name="wuli"id="mwuli" required autocomplete="off" placeholder="物理" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">化学</label>
                <div class="layui-input-inline">
                    <input type="text" name="huaxue" id="mhuaxue" required  placeholder="化学" lay-verify="scoreNum"  autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">生物</label>
                <div class="layui-input-inline">
                    <input type="tel" name="shengwu" id="mshengwu" required  autocomplete="off" placeholder="生物" lay-verify="scoreNum"   class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formmodify">立即提交</button>
                <!--<button type="reset" class="layui-btn layui-btn-primary" id="modifyReset" >重置</button>-->
            </div>
        </div>
    </form>
</div>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">录入成绩</button>
        <div class="layui-upload">
            <button type="button" class="layui-btn layui-btn-sm" id="changeFile">选择文件</button>
            <button type="button" class="layui-btn layui-btn-sm" id="startUpload">开始上传</button>
        </div>
    </div>

</script>

<script type="text/html" id="barDemo">
    <!-- <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>-->
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
</script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
    layui.form.render("select");
    var insertVar;
    var modifyVar;
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功

        //执行一个laydate实例
        laydate.render({
            elem: '#testTime' //指定元素
            //,type: 'year'
            ,done: function(value, date, endDate){
                console.log(value); //得到日期生成的值，如：2017-08-18

               //动态加载班级学生
                $.ajax({
                    url:'/classInfo/getStudentInfo',
                    dataType:'json',
                    type:'post',
                    data:{testTime:value},
                    success:function(data){
                        $('#studentNum').empty();
                        $.each(data,function(index,item){
                            $('#studentNum').append(new Option(item.name,item.id));//往下拉菜单里添加元素
                        })
                        form.render();//菜单渲染 把内容加载进去
                    }
                });

            }
        });
        laydate.render({
            elem:'#dateSearch'
            // ,type: 'year'
            ,done: function(value, date, endDate) {
                console.log(value); //得到日期生成的值，如：2017-08-18
                // todo 重新刷表单
                 var tableSearch = layui.table;
                 //执行重载
                 tableSearch.reload('test', {
                     page: {
                         curr: 1 //重新从第 1 页开始
                     }
                     ,where: {
                         testTime: value
                     }
                 });
            }
        });
        //自定义验证规则
        form.verify({
            scoreNum: [
                /^[\d]+$/
                ,'密码必须数字，且不能出现空格'
            ]
        });

    });
    var modifyData='';
    var insertVar;
    layui.use('table', function(){
        var table = layui.table;
        var modifyform=layui.form;

        table.render({
            elem: '#test'
            ,url:'/student/getScore'
            ,toolbar: '#toolbarDemo'
            /* ,toolbar: 'default'*/
            /* ,toolbar: true*/
            /* ,toolbar:'default'*/
            ,title: '成绩数据表'
            ,cols: [[
                {field:'studentname', title:'姓名', width:80 , align: 'center' }
                ,{field:'studentnum', title:'学号', width:100  , align: 'center' }
                ,{field:'testTime', title:'考试时间', width:200, align: 'center'}
                ,{field:'yuwen', title:'语文', width:90,sort: true, align: 'center'}
                ,{field:'shuxue', title:'数学',width:90,sort: true, align: 'center'}
                ,{field:'yingyu', title:'英语',width:90,sort: true, align: 'center'}
                ,{field:'wuli', title:'物理',width:90,sort: true, align: 'center'}
                ,{field:'huaxue', title:'化学',width:90,sort: true, align: 'center'}
                ,{field:'shengwu', title:'生物',width:90,sort: true, align: 'center'}
                ,{field:'zongfen', title:'总分',width:90,sort: true, align: 'center'}
                ,{fixed: 'right', title:'操作', toolbar: '#barDemo', width:120 , align: 'center'}
            ]]
            ,page: true
            ,limit: 40

        });

        //监听头工具栏事件
        table.on('toolbar(test)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //获取选中的数据
            switch(obj.event){
                case 'add':
                    //layer.msg('添加233');
                    //页面层-自定义
                    $('#addReset').trigger("click");
                    insertVar=layer.open({
                        type: 1,
                        title:"登记信息",
                        // closeBtn: true,
                        shift: 2,
                        area: ['980px', '480px'],
                        shadeClose: true,
                        //btn: ['新增', '取消'],
                        // btnAlign: 'c',
                        content: $("#add-main"),
                        yes: function(index, layero){
                            //do something

                            return false;
                            layer.close(index); //如果设定了yes回调，需进行手工关闭
                            $("#add-main").css("display","none");
                        }
                        ,btn2: function(index, layero){
                            //按钮【按钮二】的回调
                            layer.close(insertVar); //如果设定了yes回调，需进行手工关闭
                            $("#add-main").css("display","none");
                            //return false 开启该代码可禁止点击该按钮关闭
                        }
                        ,cancel: function(index, layero){
                            /* if(confirm('确定要关闭么')){ //只有当点击confirm框的确定时，该层才会关闭
                                 layer.close(index);
                                 $("#add-main").css("display","none");
                             }*/
                            layer.close(insertVar);
                            $("#add-main").css("display","none");
                            return false;
                        }
                    });
                    break;
            };
        });

        //监听行工具事件
        table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data //获得当前行数据
                ,layEvent = obj.event; //获得 lay-event 对应的值
            //console.log(data.id);
            if(layEvent === 'detail'){
                layer.msg('查看操作: '+JSON.stringify(data));
            } else if(layEvent === 'del'){
                //  <span class="layui-badge layui-bg-blue">蓝</span>
                layer.confirm('真的删除工号:<span class="layui-badge layui-bg-blue">'+data.teacherNum+'</span> ,名字:<span class="layui-badge layui-bg-blue">'+data.teacherName+'</span> 的老师吗?', function(index){
                    //向服务端发送删除指令
                    $.ajax({
                        url:"/teacher/deleteById",
                        type:"post",
                        data:{id:data.id},
                        success:function(result){
                            if(result.status){
                                obj.del(); //删除对应行（tr）的DOM结构
                                layer.close(index);
                            }else {
                                layer.msg( result.msg);
                            }
                        },
                        error:function(e){
                            layer.msg('错误！！');
                        }
                    });
                });
            } else if(layEvent === 'edit'){
                //layer.msg('编辑操作');
                modifyData=data;
                console.log(modifyData)
                $("#mtestTime").val(modifyData.testTime);
                $("#mstudentNum").val(modifyData.studentnum);
                $("#myuwen").val(modifyData.yuwen);
                $("#mshuxue").val(modifyData.shuxue);
                $("#myingyu").val(modifyData.yingyu);
                $("#mwuli").val(modifyData.wuli);
                $("#mhuaxue").val(modifyData.huaxue);
                $("#mshengwu").val(modifyData.shengwu);
                modifyVar=layer.open({
                    type: 1,
                    title:"修改信息",
                    // closeBtn: true,
                    shift: 2,
                    area: ['980px', '480px'],
                    shadeClose: true,
                    //btn: ['新增', '取消'],
                    // btnAlign: 'c',
                    content: $("#add-modofy"),
                    cancel: function(index, layero){
                        /* if(confirm('确定要关闭么')){ //只有当点击confirm框的确定时，该层才会关闭
                             layer.close(index);
                             $("#add-main").css("display","none");
                         }*/
                        layer.close(modifyVar);
                        $("#add-modofy").css("display","none");
                        return false;
                    }
                });

            }
        });

    });
    layui.use('form', function(){
        var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
        //……
        //但是，如果你的HTML是动态生成的，自动渲染就会失效
        //因此你需要在相应的地方，执行下述方法来手动渲染，跟这类似的还有 element.init();
        form.render();
        $.ajax({
            url:'/classInfo/getClassName',
            dataType:'json',
            type:'post',
            success:function(data){
                $.each(data,function(index,item){
                    $('#selectID').append(new Option(item.name,item.id));//往下拉菜单里添加元素
                })
                form.render();//菜单渲染 把内容加载进去
            }
        });
        //监听提交
        form.on('submit(formDemo)', function(data){
            console.log(JSON.stringify(data.field));
            /*提交表单*/
            $.ajax({
                url:'/student/modifyscore',
                method:'post',
                data:data.field,
                dataType:'JSON',
                success:function(res){
                    console.log(res);
                    if(res.code==0){
                        layer.msg(res.msg);
                        layer.close(insertVar); //如果设定了yes回调，需进行手工关闭
                        $("#add-main").css("display","none");
                        //刷新表单
                        layui.table.reload('test', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                        });
                    }
                    else{
                        console.log(res.msg);
                        layer.msg(res.msg);
                    }
                },
                error:function(data){
                    layer.msg("服务器错误");
                }
            });
            return false;//如果不加这句，则ajax的回调函数不执行
        });
        form.on('submit(formmodify)', function(data){
            //$('#modifyReset').trigger("click");
            console.log(JSON.stringify(data.field));
            /*提交表单*/
            $.ajax({
                url:'/student/modify',
                method:'post',
                data:data.field,
                dataType:'JSON',
                success:function(res){
                    console.log(res);
                    if(res.code==0){
                        layer.msg(res.msg);
                        layer.close(modifyVar);//如果设定了yes回调，需进行手工关闭
                        $("#add-modofy").css("display","none");
                        //刷新表单
                        layui.table.reload('test', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                        });
                    }
                    else{
                        console.log(res.msg);
                        layer.msg(res.msg);
                    }
                },
                error:function(data){
                    layer.msg("服务器错误");
                }
            });
            return false;//如果不加这句，则ajax的回调函数不执行
        });
        form.on('select(selectTestTime)', function(data){
            console.log(data.value); //得到被选中的值
            //刷新表单
            layui.table.reload('test', {
                page: {
                    curr: 1 //重新从第 1 页开始
                } ,where: {
                    testTime: data.value
                }
            });
        });
    });
    layui.use('upload', function(){
        var $ = layui.jquery
            ,upload = layui.upload;
        //选完文件后不自动上传
        upload.render({
            elem: '#changeFile'
            ,url: '/upload/studentScore'
            ,auto: false
            ,accept: 'file' //允许上传的文件类型
            //,multiple: true
            ,bindAction: '#startUpload'
            ,field:"excel"
            ,choose: function(obj){
                //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                obj.preview(function(index, file, result){
                    //console.log(index); //得到文件索引
                    console.log(file.name); //得到文件对象
                   // console.log(result); //得到文件base64编码，比如图片
                    var fileName=file.name;
                    fileName =fileName.substring(fileName.lastIndexOf('.'), fileName.length);
                    if (fileName == '') {
                        alert("上传文件不能为空！");
                        return;
                    } else if (fileName != '.xlsx' && fileName != '.xls') {
                        alert("请选择正确的excel类型文件！");
                        return;
                    }
                });
            }
            ,before: function(obj){ //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                layer.load(); //上传loading
            }
            ,done: function(res, index, upload){
                layer.closeAll('loading'); //关闭loading
                console.log(res)
                layer.msg(res.msg);
            }
            ,error: function(index, upload){
                layer.closeAll('loading'); //关闭loading
            }
        });

    });
</script>
</body>
<script>
    function keyup_submit(e){
        var evt = window.event || e;
        if (evt.keyCode == 13){
            //回车事件
            $("#search").click();
        }
    }
    $.ajax({
        url: '/student/searchTestTime',
        dataType: 'json',
        type: 'get',
        success: function (data) {
            $('#selectTestTime').empty();
            $.each(data, function (index, item) {
                $('#selectTestTime').append(new Option(item, item));// 下拉菜单里添加元素
            });
            layui.form.render("select");
        }
    });

     //重新渲染 固定写法

</script>
</html>
